#!/bin/sh
# –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º set -e, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏
set +e

# –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—É—Å–∫–∞
echo "==========================================" >&2
echo "üöÄ ENTRYPOINT: –ù–∞—á–∞–ª–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞" >&2
echo "==========================================" >&2

# –ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —Å–æ–∑–¥–∞–¥–∏–º key.json –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
if [ -n "$YC_SA_KEY_JSON" ]; then
  echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ key.json –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è..." >&2
  echo "$YC_SA_KEY_JSON" > /app/key.json
  export YANDEX_SERVICE_ACCOUNT_KEY_FILE=/app/key.json
  export YC_SERVICE_ACCOUNT_KEY_FILE=/app/key.json
  echo "‚úÖ key.json —Å–æ–∑–¥–∞–Ω" >&2
else
  echo "‚ö†Ô∏è YC_SA_KEY_JSON –Ω–µ –∑–∞–¥–∞–Ω, key.json –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω" >&2
fi

# –í—ã–≤–æ–¥–∏–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–µ–¥–µ
echo "üìç –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)" >&2
echo "üêç Python: $(python --version)" >&2
echo "üì¶ –ü–æ—Ä—Ç: 8080 (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è Serverless Container)" >&2

# –ò—Å–ø–æ–ª—å–∑—É–µ–º uvicorn –¥–ª—è –∑–∞–ø—É—Å–∫–∞ FastAPI (–∫–∞–∫ –≤ –æ–±—Ä–∞–∑—Ü–µ)
echo "üöÄ –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ uvicorn..." >&2
echo "üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤:" >&2
ls -la /app/*.py >&2 || true
echo "üêç –í–µ—Ä—Å–∏—è Python:" >&2
python --version >&2
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ uvicorn:" >&2
python -c "import uvicorn; print('uvicorn OK')" >&2 || {
    echo "‚ùå uvicorn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" >&2
    exit 1
}

# –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ uvicorn (–ø–æ—Ä—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 8080 –¥–ª—è Serverless Container)
exec uvicorn main:app --host 0.0.0.0 --port 8080


