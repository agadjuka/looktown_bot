# üìä –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢: –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –í –û–ë–õ–ê–ß–ù–û–ô –í–ï–†–°–ò–ò

## –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2025-01-20
## –§–æ–∫—É—Å: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YandexGPT (–æ–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è)

---

## üéØ –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï

**–ü–æ—á–µ–º—É –ø—Ä–æ–µ–∫—Ç –ù–ï –∑–∞—Å—ã–ø–∞–µ—Ç –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö –æ—Ç YandexGPT:**

1. ‚úÖ –í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ YandexGPT –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `run_in_executor()` - –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç event loop
2. ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `asyncio.to_thread()` - –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç event loop  
3. ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å Telegram API –∏—Å–ø–æ–ª—å–∑—É—é—Ç `httpx.AsyncClient` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
4. ‚úÖ –í–µ–±—Ö—É–∫ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á

---

## üìã –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –û–ë–†–ê–ë–û–¢–ö–ò –°–û–û–ë–©–ï–ù–ò–ô

### 1. –¢–û–ß–ö–ê –í–•–û–î–ê: Telegram Webhook

**–§–∞–π–ª:** `app/api/telegram.py`

```python
@router.post(f"/{settings.TELEGRAM_BOT_TOKEN}", include_in_schema=False)
async def telegram_webhook(request: Request):
    """
    –û—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∏–µ–º–∞ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Telegram.
    –í—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–∞.
    """
    try:
        logger.info("--- [WEBHOOK START] –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç Telegram.")
        update_data = await request.json()
        update = Update.model_validate(update_data)
        # –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        logger.info("--- [WEBHOOK] –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è (await)...")
        await process_telegram_update(update)
        logger.info("--- [WEBHOOK] –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ó–ê–í–ï–†–®–ï–ù–ê.")
        logger.info("--- [WEBHOOK END] –û—Ç–ø—Ä–∞–≤–ª—è—é 200 OK –≤ Telegram.")
        return {"status": "ok"}
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ webhook: {e}")
        return {"status": "error", "message": str(e)}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –≠–Ω–¥–ø–æ–∏–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è `async def` - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ FastAPI
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `await process_telegram_update(update)` - **–û–ñ–ò–î–ê–ï–¢** –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Event loop –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `BackgroundTasks`, —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º 200 OK. –ù–æ —ç—Ç–æ –ù–ï –ø—Ä–æ–±–ª–µ–º–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –±–ª–∞–≥–æ–¥–∞—Ä—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

---

### 2. –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø: process_telegram_update

**–§–∞–π–ª:** `app/api/telegram.py`

```python
async def process_telegram_update(update: Update):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç Telegram.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç DialogService –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    """
    if update.message and update.message.text:
        chat_id = update.message.chat.id
        user_id = update.message.from_user.id if update.message.from_user else chat_id
        text = update.message.text
        
        try:
            # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä DialogService
            dialog_service = DialogService()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π /clear
            if text.strip().lower() == "/clear":
                deleted_count = dialog_service.clear_history(user_id)
                confirmation_message = "..."
                await telegram_service.send_message(chat_id, confirmation_message)
            else:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
                bot_response = await dialog_service.process_user_message(user_id, text)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                await telegram_service.send_message(chat_id, bot_response)
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è (`async def`)
- –í—ã–∑–æ–≤—ã `dialog_service.process_user_message()` –∏ `telegram_service.send_message()` –∏—Å–ø–æ–ª—å–∑—É—é—Ç `await`
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç event loop

---

### 3. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò: DialogService.process_user_message

**–§–∞–π–ª:** `app/services/dialog_service.py`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ë–î
2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –≠—Ç–∞–ø 1: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∞–¥–∏–∏ (–≤—ã–∑–æ–≤ LLM)
5. –≠—Ç–∞–ø 2: –ú—ã—à–ª–µ–Ω–∏–µ (–≤—ã–∑–æ–≤ LLM + –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
6. –≠—Ç–∞–ø 3: –°–∏–Ω—Ç–µ–∑ (–≤—ã–∑–æ–≤ LLM + –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
8. –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´:**

#### 3.1. –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö - –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç event loop

```python
# –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –æ–±–µ—Ä–Ω—É—Ç—ã –≤ asyncio.to_thread():
client = await asyncio.to_thread(self.client_repository.get_or_create_by_telegram_id, user_id)
history_records = await asyncio.to_thread(self.repository.get_recent_messages, user_id, limit=self.CONTEXT_WINDOW_SIZE)
await asyncio.to_thread(self.repository.add_message, user_id=user_id, role="user", message_text=text)
await asyncio.to_thread(self.repository.add_message, user_id=user_id, role="model", message_text=bot_response_text)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- `asyncio.to_thread()` –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- Event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –∏ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ –ø—É–ª–µ –ø–æ—Ç–æ–∫–æ–≤ Python

#### 3.2. –í—ã–∑–æ–≤—ã LLM - –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç event loop

```python
# –≠—Ç–∞–ø 1: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
stage_str = await self.llm_service.generate_response(classification_history, tracer=tracer)

# –≠—Ç–∞–ø 2: –ú—ã—à–ª–µ–Ω–∏–µ
thinking_response = await self.llm_service.generate_response(thinking_history, filtered_tools, tracer=tracer)

# –≠—Ç–∞–ø 3: –°–∏–Ω—Ç–µ–∑
synthesis_response = await self.llm_service.generate_response(synthesis_history, filtered_tools, tracer=tracer)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –°–º. —Ä–∞–∑–¥–µ–ª 4 (LLMService)

---

### 4. –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° YANDEXGPT: LLMService

**–§–∞–π–ª:** `app/services/llm_service.py`

#### 4.1. –ú–µ—Ç–æ–¥ _send_yandex_message - –ö–õ–Æ–ß–ï–í–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

```python
async def _send_yandex_message(self, history: List[Dict], message, user_id: int = None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ YandexGPT."""
    
    # ... —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload ...
    
    start_time = time.perf_counter()
    try:
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º asyncio –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–∞
        loop = asyncio.get_event_loop()
        response = await loop.run_in_executor(
            None,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º default executor (ThreadPoolExecutor)
            lambda: requests.post(self._yandex_base_url, json=payload, headers=headers)
        )
        duration_ms = int((time.perf_counter() - start_time) * 1000)

        if response.status_code != 200:
            logger.error(f"‚ùå [Yandex] –û—à–∏–±–∫–∞ HTTP {response.status_code}: {response.text[:120]}")

        response.raise_for_status()

        result = response.json()

        logger.info(
            f"‚è±Ô∏è [LLM Timing] provider=yandex user_id={user_id} duration_ms={duration_ms} prompt_len={len(payload.get('messages', []))}"
        )

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å Gemini
        return self._format_yandex_response(result)

    except Exception as e:
        duration_ms = int((time.perf_counter() - start_time) * 1000)
        logger.error(f"‚ùå [LLM Timing] provider=yandex user_id={user_id} duration_ms={duration_ms} –æ—à–∏–±–∫–∞={str(e)}")
        raise
```

**–ü–û–ß–ï–ú–£ –≠–¢–û –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**

1. **`requests.post()` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞:**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ï—Å–ª–∏ –≤—ã–∑–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ async —Ñ—É–Ω–∫—Ü–∏–∏, –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å event loop
   - –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —Å–º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è

2. **`run_in_executor()` - —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é `requests.post()` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
   - Event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç YandexGPT
   - –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

3. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è default executor:**
   - `None` –≤ –ø–µ—Ä–≤–æ–º –∞—Ä–≥—É–º–µ–Ω—Ç–µ –æ–∑–Ω–∞—á–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `ThreadPoolExecutor` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - Python –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è —Ç–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ YandexGPT –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö

#### 4.2. –ú–µ—Ç–æ–¥ _generate_yandex_response

```python
async def _generate_yandex_response(self, history: List[Dict], tracer=None) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ YandexGPT."""
    enhanced_history = self._enhance_history_for_yandex(history)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–û—Ç–≤–µ—Ç—å" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    response_content = await self.send_message_to_chat(enhanced_history, "–û—Ç–≤–µ—Ç—å")
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    response_text = ""
    for part in response_content.parts:
        if hasattr(part, 'text') and part.text:
            response_text += part.text
    
    return response_text if response_text else "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç."
```

**–¶–µ–ø–æ—á–∫–∞ –≤—ã–∑–æ–≤–æ–≤:**
1. `_generate_yandex_response()` –≤—ã–∑—ã–≤–∞–µ—Ç
2. `send_message_to_chat()`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç
3. `_send_yandex_message()`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
4. `run_in_executor()` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–µ—Å—å –ø—É—Ç—å –æ—Ç –≤—ã–∑–æ–≤–∞ LLM –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop.

---

### 5. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –í TELEGRAM: TelegramService

**–§–∞–π–ª:** `app/services/telegram_service.py`

```python
async def send_message(self, chat_id: int, text: str) -> bool:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram."""
    url = f"{self.api_url}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
    }
    
    async with httpx.AsyncClient() as client:
        try:
            response = await client.post(url, json=payload)
            response.raise_for_status()
            logger.info("‚úÖ TELEGRAM: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ")
            return True
        except httpx.HTTPStatusError as e:
            logger.error(f"‚ùå TELEGRAM: HTTP –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e.response.status_code}")
            return False
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `httpx.AsyncClient` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- `await client.post()` - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `run_in_executor()`

---

### 6. –í–´–ü–û–õ–ù–ï–ù–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í: ToolOrchestratorService

**–§–∞–π–ª:** `app/services/tool_orchestrator_service.py`

```python
async def execute_single_tool(self, tool_name: str, parameters: Dict, user_id: int, dialog_context: Dict = None, tracer=None) -> str:
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞."""
    # ...
    result = await self._execute_function_async(tool_name, parameters, user_id, tracer)
    return result
```

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–æ –æ–Ω–∏ —Ç–∞–∫–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `asyncio.to_thread()` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## üîç –ü–û–ß–ï–ú–£ –ü–†–û–ï–ö–¢ –ù–ï –ó–ê–°–´–ü–ê–ï–¢

### –ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç:

**–ï—Å–ª–∏ –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–±–ª–æ–∫–∏—Ä—É–µ—Ç event loop):
response = requests.post(url, json=payload)  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∞ 5-10 —Å–µ–∫—É–Ω–¥
```

**–ü—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ—Ç YandexGPT (5-10 —Å–µ–∫—É–Ω–¥):**
- Event loop –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è
- –°–µ—Ä–≤–µ—Ä "–∑–∞—Å—ã–ø–∞–µ—Ç" –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ

### –†–µ—à–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ:

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop):
response = await loop.run_in_executor(
    None,
    lambda: requests.post(url, json=payload)
)
```

**–ü—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ—Ç YandexGPT (5-10 —Å–µ–∫—É–Ω–¥):**
- `requests.post()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- Event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º
- –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤—ã–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üìä –ü–û–¢–û–ö –û–ë–†–ê–ë–û–¢–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø (–î–ï–¢–ê–õ–¨–ù–û)

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:

```
T0: Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –∑–∞–ø—Ä–æ—Å
    ‚Üì
T1: FastAPI –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
    ‚Üì
T2: –í—ã–∑–æ–≤ await process_telegram_update()
    ‚Üì
T3: –í—ã–∑–æ–≤ await dialog_service.process_user_message()
    ‚Üì
T4: [–ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û] –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î —á–µ—Ä–µ–∑ asyncio.to_thread()
     ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ—Ç–æ–∫ 1)
     ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ—Ç–æ–∫ 2)
     ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ—Ç–æ–∫ 3)
    ‚Üì
T5: –í—ã–∑–æ–≤ await llm_service.generate_response() (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)
    ‚Üì
T6: –í—ã–∑–æ–≤ await llm_service.send_message_to_chat()
    ‚Üì
T7: [–ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û] HTTP –∑–∞–ø—Ä–æ—Å –∫ YandexGPT —á–µ—Ä–µ–∑ run_in_executor()
     ‚îî‚îÄ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø–æ—Ç–æ–∫–µ 4 (–ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop)
    ‚Üì
T8: [–í —ç—Ç–æ –≤—Ä–µ–º—è event loop –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã]
    ‚Üì
T9: YandexGPT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç (—á–µ—Ä–µ–∑ 3-10 —Å–µ–∫—É–Ω–¥)
    ‚Üì
T10: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–º—ã—à–ª–µ–Ω–∏–µ, —Å–∏–Ω—Ç–µ–∑)
    ‚Üì
T11: –í—ã–∑–æ–≤ await telegram_service.send_message()
     ‚îî‚îÄ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ httpx (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
    ‚Üì
T12: –í–æ–∑–≤—Ä–∞—Ç 200 OK –≤ Telegram
    ‚Üì
T13: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
```

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** –ù–∞ —à–∞–≥–∞—Ö T7-T9 event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –∏ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ –≤–µ–±—Ö—É–∫ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.

---

## üéØ –ö–õ–Æ–ß–ï–í–´–ï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ï–®–ï–ù–ò–Ø

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `run_in_executor()` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** `requests` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫.

**–†–µ—à–µ–Ω–∏–µ:**
```python
response = await loop.run_in_executor(
    None,  # Default ThreadPoolExecutor
    lambda: requests.post(url, json=payload, headers=headers)
)
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- Event loop –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.to_thread()` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä—É—é—Ç event loop.

**–†–µ—à–µ–Ω–∏–µ:**
```python
client = await asyncio.to_thread(
    self.client_repository.get_or_create_by_telegram_id, 
    user_id
)
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ë–î –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- Event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ë–î –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `httpx.AsyncClient` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç executor.

```python
async with httpx.AsyncClient() as client:
    response = await client.post(url, json=payload)
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ù–∞—Ç–∏–≤–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
- –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîÑ –°–†–ê–í–ù–ï–ù–ò–ï: –ü–†–ê–í–ò–õ–¨–ù–´–ô vs –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î (–ø—Ä–∏–≤–æ–¥–∏—Ç –∫ "–∑–∞—Å—ã–ø–∞–Ω–∏—é"):

```python
# –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –≤ async —Ñ—É–Ω–∫—Ü–∏–∏
async def _send_yandex_message(self, ...):
    response = requests.post(url, json=payload)  # ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç event loop
    return response
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- Event loop –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
- –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –°–µ—Ä–≤–µ—Ä "–∑–∞—Å—ã–ø–∞–µ—Ç" –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ):

```python
# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ executor
async def _send_yandex_message(self, ...):
    loop = asyncio.get_event_loop()
    response = await loop.run_in_executor(
        None,
        lambda: requests.post(url, json=payload)
    )  # ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
    return response
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Event loop –æ—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º
- –î—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤—ã–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üìà –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ò –ú–ê–°–®–¢–ê–ë–ò–†–£–ï–ú–û–°–¢–¨

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

**–°—Ü–µ–Ω–∞—Ä–∏–π:** 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, YandexGPT –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥.

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π):**
- –ó–∞–ø—Ä–æ—Å 1: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è 5 —Å–µ–∫—É–Ω–¥, –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–µ—Ä
- –ó–∞–ø—Ä–æ—Å 2-5: –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ 1
- **–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~25 —Å–µ–∫—É–Ω–¥ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–≤ –ø—Ä–æ–µ–∫—Ç–µ):**
- –ó–∞–ø—Ä–æ—Å 1-5: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö
- Event loop –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- **–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~5 —Å–µ–∫—É–Ω–¥ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:

**ThreadPoolExecutor:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ (–æ–±—ã—á–Ω–æ = CPU cores * 5)
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ç–æ–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç I/O-bound –æ–ø–µ—Ä–∞—Ü–∏–∏ (HTTP –∑–∞–ø—Ä–æ—Å—ã, –ë–î)

---

## ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### 1. –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ø–æ—Ç–æ–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç 1000 –∑–∞–ø—Ä–æ—Å–æ–≤, –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –ø–æ—Ç–æ–∫–æ–≤.

**–†–µ—à–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ:**
- FastAPI + uvicorn –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ThreadPoolExecutor –∏–º–µ–µ—Ç —Ä–∞–∑—É–º–Ω—ã–π –ª–∏–º–∏—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é uvicorn

### 2. –î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ YandexGPT

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ YandexGPT –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ—Ä–µ–∑ 30+ —Å–µ–∫—É–Ω–¥, –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç —Ç–∞–π–º–∞—É—Ç–∏—Ç—å.

**–†–µ—à–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤–µ–±—Ö—É–∫–∞ (–æ–±—ã—á–Ω–æ 20-60 —Å–µ–∫—É–Ω–¥)
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ try/except
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

### 3. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç –¥–æ–ª–≥–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `asyncio.to_thread()`.

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ü–æ—á–µ–º—É –ø—Ä–æ–µ–∫—Ç –ù–ï –∑–∞—Å—ã–ø–∞–µ—Ç:

1. **HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ YandexGPT:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `run_in_executor()` - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
2. **–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `asyncio.to_thread()` - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
3. **HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ Telegram:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `httpx.AsyncClient` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
4. **Event loop:** –û—Å—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–∞–∂–µ –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –æ—Ç LLM

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –¥—Ä—É–≥–æ–º –ø—Ä–æ–µ–∫—Ç–µ:

1. ‚úÖ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (`requests`) –Ω–∞–ø—Ä—è–º—É—é –≤ async —Ñ—É–Ω–∫—Ü–∏—è—Ö**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `run_in_executor()` –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ `httpx`

2. ‚úÖ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –Ω–∞–ø—Ä—è–º—É—é –≤ async —Ñ—É–Ω–∫—Ü–∏—è—Ö**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `asyncio.to_thread()` –∏–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã –ë–î

3. ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ**
   - `httpx` –≤–º–µ—Å—Ç–æ `requests`
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã –ë–î –≤–º–µ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö

4. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ø—É—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–∏–±–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –ª–∏–±–æ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ executor

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:** –ö–∞–∂–¥—ã–π —Å–ª–æ–π (API, Service, Repository) –∏–º–µ–µ—Ç —á–µ—Ç–∫–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤–µ–∑–¥–µ:** –í—Å–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏–ª–∏ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ executor
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- **–ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´

### –§–∞–π–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è:

1. `app/api/telegram.py` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è webhook
2. `app/services/dialog_service.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. `app/services/llm_service.py` - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å YandexGPT
4. `app/services/telegram_service.py` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
5. `app/services/tool_orchestrator_service.py` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:

- `LLMService._send_yandex_message()` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å `run_in_executor()`
- `DialogService.process_user_message()` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å `asyncio.to_thread()`
- `TelegramService.send_message()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ `httpx`

---

**–ö–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞**

