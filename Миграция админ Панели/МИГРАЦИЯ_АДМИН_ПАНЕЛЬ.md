# –ü–∞–∫–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–∞ –±–∞–∑–µ Telegram Forum Topics

## üìÅ –§–∞–π–ª—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (6 —Ñ–∞–π–ª–æ–≤)

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:

1. `app/config/admin_config.py` ‚Üí `app/config/admin_config.py`
2. `app/storage/topic_storage.py` ‚Üí `app/storage/topic_storage.py`
3. `app/storage/firestore_topic_storage.py` ‚Üí `app/storage/firestore_topic_storage.py`
4. `app/storage/topic_storage_factory.py` ‚Üí `app/storage/topic_storage_factory.py`
5. `app/storage/__init__.py` ‚Üí `app/storage/__init__.py` (–æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å)
6. `app/telegram/admin_service.py` ‚Üí `app/telegram/admin_service.py`

---

## ‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö

### 1. `app/telegram/service.py`

#### –ò–º–ø–æ—Ä—Ç—ã (–¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ):
```python
from app.config.admin_config import get_telegram_admin_group_id
from app.storage import get_topic_storage
from app.telegram.admin_service import AdminPanelService
```

#### –í –∫–ª–∞—Å—Å–µ `AgentService`, –≤ `__init__` (–¥–æ–±–∞–≤–∏—Ç—å):
```python
self._admin_service: Optional[AdminPanelService] = None
```

#### –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ –∫–ª–∞—Å—Å `AgentService`:
```python
def _get_admin_service(self, bot: Bot) -> Optional[AdminPanelService]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä AdminPanelService."""
    if self._admin_service is None:
        admin_group_id = get_telegram_admin_group_id()
        if admin_group_id is None:
            logger.debug("–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (TELEGRAM_ADMIN_GROUP_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")
            return None

        try:
            storage = get_topic_storage()
            self._admin_service = AdminPanelService(
                bot=bot,
                storage=storage,
                admin_group_id=admin_group_id,
            )
            logger.debug("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω AdminPanelService")
        except Exception as e:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å AdminPanelService: %s", str(e))
            return None

    return self._admin_service
```

#### –í –º–µ—Ç–æ–¥–µ `process_message()`, –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ (–ø–æ—Å–ª–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è):
```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
admin_service = self._get_admin_service(bot)
if admin_service and user and message:
    try:
        await admin_service.forward_message_to_admin(
            user=user,
            message=message,
            source="User",
        )
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: %s", str(e))

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: –µ—Å–ª–∏ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
if admin_service:
    if admin_service.is_user_in_manual_mode(int(user_id)):
        logger.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å user_id=%s –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ. –ò–ò –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è.", user_id)
        return None
```

#### –í –±–ª–æ–∫–µ CallManager (–∑–∞–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è):
```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
if admin_service and user:
    try:
        await admin_service.send_call_manager_notification(
            user=user,
            reason=call_manager_info["reason"],
            recent_messages=all_messages[-6:],
        )
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ CallManager –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: %s", str(e))
        # Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
        await self.manager_notification_service.send_manager_notification(
            bot=bot,
            client_telegram_id=int(user_id),
            reason=call_manager_info["reason"],
            recent_messages=all_messages[-6:],
            manager_chat_id=None
        )
else:
    # –ï—Å–ª–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
    await self.manager_notification_service.send_manager_notification(
        bot=bot,
        client_telegram_id=int(user_id),
        reason=call_manager_info["reason"],
        recent_messages=all_messages[-6:],
        manager_chat_id=None
    )
```

#### –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–¥–æ–±–∞–≤–∏—Ç—å):
```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
if admin_service:
    try:
        await admin_service.send_ai_response_to_topic(
            user_id=int(user_id),
            ai_text=response_text,
        )
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç AI –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: %s", str(e))
```

**–í–∞–∂–Ω–æ:** –ú–µ—Ç–æ–¥ `process_message()` –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å `user: Optional[User]` –∏ `message: Optional[Message]`.

---

### 2. `app/telegram/handlers.py`

#### –ò–º–ø–æ—Ä—Ç (–¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ):
```python
from app.config.admin_config import get_telegram_admin_group_id
```

#### –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ –∫–ª–∞—Å—Å `MessageHandlers`:

**`handle_admin_message()`:**
```python
async def handle_admin_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–æ–≤ –≤ –∞–¥–º–∏–Ω—Å–∫–æ–π –≥—Ä—É–ø–ø–µ."""
    if not update.message:
        return

    message = update.message
    chat_id = update.effective_chat.id
    admin_group_id = get_telegram_admin_group_id()

    if admin_group_id is None or chat_id != admin_group_id:
        return
    if message.message_thread_id is None:
        return
    if message.from_user and message.from_user.is_bot:
        return
    if message.text and message.text.startswith("/"):
        return

    topic_id = message.message_thread_id

    try:
        admin_service = self.agent_service._get_admin_service(context.bot)
        if admin_service is None:
            logger.warning("AdminPanelService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.")
            return

        user_id = admin_service.storage.get_user_id(topic_id)
        if user_id is None:
            logger.warning("–ù–µ –Ω–∞–π–¥–µ–Ω user_id –¥–ª—è topic_id=%s. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–ª–∞–Ω–æ.", topic_id)
            return

        mode = admin_service.storage.get_mode(user_id)

        if mode == "auto":
            await context.bot.send_message(
                chat_id=admin_group_id,
                text="‚ö†Ô∏è –í–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç—É.\n"
                     "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /manager –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º.",
                message_thread_id=topic_id,
                reply_to_message_id=message.message_id,
            )
        else:
            await context.bot.copy_message(
                chat_id=user_id,
                from_chat_id=admin_group_id,
                message_id=message.message_id,
            )
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞: %s", str(e), exc_info=True)
```

**`handle_manager_command()`:**
```python
async def handle_manager_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /manager –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞."""
    if not update.message:
        return

    message = update.message
    chat_id = update.effective_chat.id
    admin_group_id = get_telegram_admin_group_id()

    if admin_group_id is None or chat_id != admin_group_id:
        return
    if message.message_thread_id is None:
        return

    topic_id = message.message_thread_id

    try:
        admin_service = self.agent_service._get_admin_service(context.bot)
        if admin_service is None:
            logger.warning("AdminPanelService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ö–æ–º–∞–Ω–¥–∞ /manager –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.")
            return

        await admin_service.enable_manual_mode(topic_id)
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /manager: %s", str(e), exc_info=True)
```

**`handle_bot_command()`:**
```python
async def handle_bot_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /bot –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞."""
    if not update.message:
        return

    message = update.message
    chat_id = update.effective_chat.id
    admin_group_id = get_telegram_admin_group_id()

    if admin_group_id is None or chat_id != admin_group_id:
        return
    if message.message_thread_id is None:
        return

    topic_id = message.message_thread_id

    try:
        admin_service = self.agent_service._get_admin_service(context.bot)
        if admin_service is None:
            logger.warning("AdminPanelService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ö–æ–º–∞–Ω–¥–∞ /bot –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.")
            return

        await admin_service.enable_auto_mode(topic_id)
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /bot: %s", str(e), exc_info=True)
```

---

### 3. `app/telegram/bot.py`

#### –ò–º–ø–æ—Ä—Ç—ã (–¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ):
```python
from telegram import BotCommand, Update
try:
    from telegram import BotCommandScopeChat, BotCommandScopeDefault
except ImportError:
    try:
        from telegram.constants import BotCommandScopeChat, BotCommandScopeDefault
    except ImportError:
        from telegram.helpers import BotCommandScopeChat, BotCommandScopeDefault

from app.config.admin_config import get_telegram_admin_group_id
```

#### –î–ª—è webhook —Ä–µ–∂–∏–º–∞ (–¥–æ–±–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ):
```python
_webhook_application: Application | None = None
_webhook_bot_token: str | None = None
_commands_set: bool = False
```

#### –î–ª—è webhook —Ä–µ–∂–∏–º–∞ (–¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é):
```python
async def _set_bot_commands_for_webhook(bot_token: str) -> None:
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –¥–ª—è webhook —Ä–µ–∂–∏–º–∞."""
    global _commands_set
    
    try:
        from telegram import Bot, BotCommand
        
        bot = Bot(token=bot_token)
        
        default_commands = [BotCommand("new", "–°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏")]
        await bot.set_my_commands(commands=default_commands, scope=BotCommandScopeDefault())
        
        admin_group_id = get_telegram_admin_group_id()
        if admin_group_id is not None:
            admin_commands = [
                BotCommand("manager", "üë®‚Äçüíª –í–∫–ª—é—á–∏—Ç—å —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º"),
                BotCommand("bot", "ü§ñ –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º –ò–ò"),
            ]
            await bot.set_my_commands(
                commands=admin_commands,
                scope=BotCommandScopeChat(chat_id=admin_group_id),
            )
        
        _commands_set = True
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (webhook): %s", str(e), exc_info=True)
```

#### –í `_get_webhook_application()` (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è handlers, –¥–æ–±–∞–≤–∏—Ç—å):
```python
admin_group_id = get_telegram_admin_group_id()
if admin_group_id is not None:
    admin_chat_filter = filters.Chat(chat_id=admin_group_id)
    _webhook_application.add_handler(
        CommandHandler("manager", handlers.handle_manager_command, filters=admin_chat_filter)
    )
    _webhook_application.add_handler(
        CommandHandler("bot", handlers.handle_bot_command, filters=admin_chat_filter)
    )
    _webhook_application.add_handler(
        MessageHandler(admin_chat_filter & ~filters.COMMAND, handlers.handle_admin_message)
    )
```

#### –í `_setup_handlers()` –∫–ª–∞—Å—Å–∞ `TelegramBot` (–¥–æ–±–∞–≤–∏—Ç—å):
```python
admin_group_id = get_telegram_admin_group_id()
if admin_group_id is not None:
    admin_chat_filter = filters.Chat(chat_id=admin_group_id)
    self.application.add_handler(
        CommandHandler("manager", self.handlers.handle_manager_command, filters=admin_chat_filter)
    )
    self.application.add_handler(
        CommandHandler("bot", self.handlers.handle_bot_command, filters=admin_chat_filter)
    )
    self.application.add_handler(
        MessageHandler(admin_chat_filter & ~filters.COMMAND, self.handlers.handle_admin_message)
    )
```

#### –î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `set_commands()`:
```python
async def set_commands(self) -> None:
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    bot = self.application.bot
    
    default_commands = [BotCommand("new", "–°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏")]
    await bot.set_my_commands(commands=default_commands, scope=BotCommandScopeDefault())
    
    admin_group_id = get_telegram_admin_group_id()
    if admin_group_id is not None:
        admin_commands = [
            BotCommand("manager", "üë®‚Äçüíª –í–∫–ª—é—á–∏—Ç—å —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º"),
            BotCommand("bot", "ü§ñ –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º –ò–ò"),
        ]
        await bot.set_my_commands(
            commands=admin_commands,
            scope=BotCommandScopeChat(chat_id=admin_group_id),
        )
```

#### –í `start_polling()` (–¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤):
```python
async def start_polling(self) -> None:
    await self.initialize()
    await self.set_commands()  # –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    await self.application.run_polling()
```

---

### 4. `main.py` (—Ç–æ–ª—å–∫–æ –¥–ª—è webhook —Ä–µ–∂–∏–º–∞)

#### –ò–º–ø–æ—Ä—Ç (–¥–æ–±–∞–≤–∏—Ç—å):
```python
from app.telegram.bot import _set_bot_commands_for_webhook, _get_webhook_application
```

#### –î–æ–±–∞–≤–∏—Ç—å startup event:
```python
@app.on_event("startup")
async def startup_event() -> None:
    bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
    if bot_token:
        try:
            application = await _get_webhook_application(bot_token)
            logger.info("Application –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Application –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: %s", str(e))
```

#### –î–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç:
```python
@app.post("/telegram/set-commands")
async def set_commands_endpoint() -> JSONResponse:
    bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not bot_token:
        return JSONResponse(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            content={"error": "Bot token not configured"},
        )
    
    try:
        await _set_bot_commands_for_webhook(bot_token)
        return JSONResponse(
            status_code=status.HTTP_200_OK,
            content={"status": "ok", "message": "–ö–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"},
        )
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥: %s", str(e), exc_info=True)
        return JSONResponse(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            content={"error": str(e)},
        )
```

---

### 5. `app/storage/__init__.py`

–ï—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–∏—Ç—å:
```python
from app.storage.topic_storage import BaseTopicStorage
from app.storage.firestore_topic_storage import FirestoreTopicStorage
from app.storage.topic_storage_factory import get_topic_storage

__all__ = [
    "BaseTopicStorage",
    "FirestoreTopicStorage",
    "get_topic_storage",
]
```

–ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞—Ç—å —Å —ç—Ç–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

---

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```python
google-cloud-firestore>=2.0.0
python-telegram-bot>=21.0.0
```

---

## üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: ID –≥—Ä—É–ø–ø—ã Telegram –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
# –ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –±–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
TELEGRAM_ADMIN_GROUP_ID=-1001234567890

# –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
GOOGLE_CLOUD_PROJECT=your-project-id
FIRESTORE_DATABASE=(default)  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
```

---

## ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å 6 –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
2. –ò–∑–º–µ–Ω–∏—Ç—å `app/telegram/service.py` (–¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã, –º–µ—Ç–æ–¥ `_get_admin_service()`, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `process_message()`)
3. –ò–∑–º–µ–Ω–∏—Ç—å `app/telegram/handlers.py` (–¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏ 3 –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–∞)
4. –ò–∑–º–µ–Ω–∏—Ç—å `app/telegram/bot.py` (–¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –º–µ—Ç–æ–¥ `set_commands()`)
5. –ò–∑–º–µ–Ω–∏—Ç—å `main.py` (—Ç–æ–ª—å–∫–æ –¥–ª—è webhook —Ä–µ–∂–∏–º–∞)
6. –û–±–Ω–æ–≤–∏—Ç—å `app/storage/__init__.py`
7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
8. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

---

**–ì–æ—Ç–æ–≤–æ. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω - –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –µ—Å–ª–∏ `TELEGRAM_ADMIN_GROUP_ID` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.**
