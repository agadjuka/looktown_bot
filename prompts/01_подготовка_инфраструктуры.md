# Этап 1: Подготовка инфраструктуры

## Задача
Подготовить инфраструктуру для работы с LangGraph: установить зависимости и обновить схему YDB для хранения Thread ID.

## Шаги выполнения

### 1. Обновить requirements.txt
Добавь следующие зависимости в файл `requirements.txt`:
```
yandex-cloud-ml-sdk>=1.0.0
langgraph>=0.2.0
pydantic>=2.0.0
```

### 2. Обновить схему YDB
В файле `src/ydb_client.py`:

1. **Обновить метод `init_schema()`** - добавить поле `thread_id` в таблицу `chat_threads`:
```python
def init_schema(self):
    """Создание таблицы для маппинга chat_id -> last_response_id и thread_id"""
    create_table_query = """
    CREATE TABLE IF NOT EXISTS chat_threads (
        chat_id String,
        thread_id String,
        last_response_id String,
        updated_at Timestamp,
        PRIMARY KEY (chat_id)
    );
    """
    def _tx(session):
        return session.execute_scheme(create_table_query)
    self.pool.retry_operation_sync(_tx)
```

2. **Добавить метод `get_thread_id()`**:
```python
def get_thread_id(self, chat_id: str) -> Optional[str]:
    """Получение thread_id по chat_id"""
    query = """
    DECLARE $id AS String; 
    SELECT thread_id FROM chat_threads WHERE chat_id = $id;
    """
    result = self._execute_query(query, {"$id": chat_id})
    rows = result[0].rows
    return rows[0].thread_id.decode() if rows and rows[0].thread_id else None
```

3. **Добавить метод `save_thread_id()`**:
```python
def save_thread_id(self, chat_id: str, thread_id: str):
    """Сохранение маппинга chat_id -> thread_id"""
    query = """
    DECLARE $cid AS String; 
    DECLARE $tid AS String;
    UPSERT INTO chat_threads (chat_id, thread_id, updated_at)
    VALUES ($cid, $tid, CurrentUtcTimestamp());
    """
    self._execute_query(query, {
        "$cid": chat_id, 
        "$tid": thread_id
    })
```

4. **Добавить метод `reset_thread()`**:
```python
def reset_thread(self, chat_id: str):
    """Сброс thread для чата"""
    query = """
    DECLARE $cid AS String;
    UPDATE chat_threads SET thread_id = NULL, updated_at = CurrentUtcTimestamp()
    WHERE chat_id = $cid;
    """
    self._execute_query(query, {"$cid": chat_id})
```

5. **Обновить метод `reset_context()`** - чтобы он также сбрасывал thread_id:
```python
def reset_context(self, chat_id: str):
    """Сброс контекста для чата (очистка last_response_id и thread_id)"""
    query = """
    DECLARE $cid AS String;
    UPDATE chat_threads SET last_response_id = NULL, thread_id = NULL, updated_at = CurrentUtcTimestamp()
    WHERE chat_id = $cid;
    """
    self._execute_query(query, {"$cid": chat_id})
```

## Проверка
После выполнения проверь:
- ✅ Зависимости добавлены в requirements.txt
- ✅ Методы для работы с thread_id добавлены в YDBClient
- ✅ Схема таблицы обновлена (можно запустить init_schema вручную для существующих таблиц)

## Важно
- Сохраняй обратную совместимость: `last_response_id` должен оставаться для старого метода
- Если таблица уже существует, может потребоваться миграция данных или пересоздание таблицы

