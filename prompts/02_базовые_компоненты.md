# Этап 2: Создание базовых компонентов

## Задача
Создать базовые компоненты для работы с LangGraph: LangGraphService и BaseAgent.

## Шаги выполнения

### 1. Создать LangGraphService
Создай файл `src/services/langgraph_service.py`:

```python
"""
Сервис для работы с LangGraph и Assistant API
"""
import os
from typing import Optional
from yandex_cloud_ml_sdk import YCloudML
from yandex_cloud_ml_sdk._threads.thread import Thread
from .logger_service import logger

class LangGraphService:
    """Сервис для работы с LangGraph и Assistant API"""
    
    def __init__(self):
        folder_id = os.getenv("YANDEX_FOLDER_ID")
        api_key = os.getenv("YANDEX_API_KEY_SECRET")
        
        if not folder_id or not api_key:
            raise ValueError("Не заданы YANDEX_FOLDER_ID или YANDEX_API_KEY_SECRET")
        
        self.sdk = YCloudML(folder_id=folder_id, auth=api_key)
        self.model = self.sdk.models.completions("yandexgpt", model_version="rc")
    
    def create_thread(self, ttl_days: int = 30) -> Thread:
        """Создание нового Thread"""
        return self.sdk.threads.create(
            ttl_days=ttl_days,
            expiration_policy="since_last_active"
        )
    
    def get_thread_by_id(self, thread_id: str) -> Optional[Thread]:
        """Получение Thread по ID"""
        try:
            return self.sdk.threads.get(thread_id)
        except Exception as e:
            logger.error(f"Ошибка получения Thread: {e}")
            return None
    
    def create_assistant(self, instruction: str, tools: list = None):
        """Создание Assistant с инструкцией и инструментами"""
        kwargs = {}
        if tools and len(tools) > 0:
            kwargs = {"tools": tools}
        
        assistant = self.sdk.assistants.create(
            self.model,
            ttl_days=30,
            expiration_policy="since_last_active",
            **kwargs
        )
        
        if instruction:
            assistant.update(instruction=instruction)
        
        return assistant
```

### 2. Обновить __init__.py в services
В файле `src/services/__init__.py` добавь импорт:
```python
from .langgraph_service import LangGraphService
```

### 3. Создать BaseAgent
Создай папку `src/agents/` и файл `src/agents/__init__.py`:
```python
"""
Модуль агентов для LangGraph
"""
```

Создай файл `src/agents/base_agent.py`:

```python
"""
Базовый класс для агентов
"""
from typing import Optional
from yandex_cloud_ml_sdk._threads.thread import Thread
from yandex_cloud_ml_sdk._assistants.assistant import Assistant
from ..services.langgraph_service import LangGraphService
from ..services.logger_service import logger

class BaseAgent:
    """Базовый класс для всех агентов"""
    
    def __init__(
        self,
        langgraph_service: LangGraphService,
        instruction: str,
        tools: list = None,
        assistant: Optional[Assistant] = None
    ):
        self.langgraph_service = langgraph_service
        self.instruction = instruction
        
        if assistant:
            self.assistant = assistant
        else:
            # Создаём инструменты
            tool_list = []
            if tools:
                self.tools = {x.__name__: x for x in tools}
                tool_list = [langgraph_service.sdk.tools.function(x) for x in tools]
            else:
                self.tools = {}
            
            # Создаём Assistant
            self.assistant = langgraph_service.create_assistant(
                instruction=instruction,
                tools=tool_list
            )
    
    def __call__(self, message: str, thread: Thread) -> str:
        """Выполнение запроса к агенту"""
        try:
            # Добавляем сообщение в Thread
            thread.write(message)
            
            # Запускаем Assistant
            run = self.assistant.run(thread)
            res = run.wait()
            
            # Обрабатываем Function Calls
            if res.tool_calls:
                result = []
                for f in res.tool_calls:
                    logger.debug(f"Вызов функции {f.function.name}", f"args={f.function.arguments}")
                    
                    if f.function.name in self.tools:
                        fn = self.tools[f.function.name]
                        obj = fn(**f.function.arguments)
                        # Вызываем process если есть, иначе преобразуем в строку
                        if hasattr(obj, 'process'):
                            x = obj.process(thread)
                        else:
                            x = str(obj)
                        result.append({"name": f.function.name, "content": x})
                
                if result:
                    run.submit_tool_results(result)
                    res = run.wait()
            
            return res.text
        
        except Exception as e:
            logger.error(f"Ошибка в агенте: {e}")
            raise
```

### 4. Обновить service_factory.py
В файле `service_factory.py` добавь поддержку LangGraphService:

```python
from src.services import LangGraphService

class ServiceFactory:
    def __init__(self):
        # ... существующие сервисы ...
        self._langgraph_service = None
    
    def get_langgraph_service(self) -> LangGraphService:
        """Получить экземпляр LangGraphService"""
        if self._langgraph_service is None:
            self._langgraph_service = LangGraphService()
        return self._langgraph_service
```

## Проверка
После выполнения проверь:
- ✅ Файл `src/services/langgraph_service.py` создан
- ✅ Файл `src/agents/base_agent.py` создан
- ✅ Папка `src/agents/` создана с `__init__.py`
- ✅ Импорты добавлены в `__init__.py` файлы
- ✅ ServiceFactory обновлён

## Важно
- Используй существующие переменные окружения: `YANDEX_FOLDER_ID`, `YANDEX_API_KEY_SECRET`
- Все ошибки должны логироваться через `logger_service`
- BaseAgent должен корректно обрабатывать Function Calls

